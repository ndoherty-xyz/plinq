<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>chirp playground</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: #111;
    color: #e0e0e0;
    padding: 24px;
    max-width: 960px;
    margin: 0 auto;
  }
  h1 { font-size: 24px; margin-bottom: 4px; }
  .subtitle { color: #888; margin-bottom: 24px; font-size: 14px; }
  h2 { font-size: 16px; margin-bottom: 12px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

  /* preset buttons */
  .presets { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 32px; }
  .presets button {
    padding: 10px 20px;
    background: #222;
    color: #e0e0e0;
    border: 1px solid #333;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-family: inherit;
    transition: background 0.1s;
  }
  .presets button:hover { background: #2a2a2a; border-color: #555; }
  .presets button:active { background: #333; }
  .presets button.active { border-color: #6c9; background: #1a2a1a; }

  /* editor */
  .editor { display: grid; grid-template-columns: 280px 1fr; gap: 24px; margin-bottom: 24px; }
  .layers { display: flex; flex-direction: column; gap: 12px; }

  .layer-card {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 16px;
  }
  .layer-card h3 {
    font-size: 13px;
    color: #888;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .layer-card h3 button {
    background: none;
    border: none;
    color: #666;
    cursor: pointer;
    font-size: 16px;
  }
  .layer-card h3 button:hover { color: #f66; }

  .field { margin-bottom: 10px; }
  .field label {
    display: block;
    font-size: 11px;
    color: #777;
    margin-bottom: 3px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .field input[type="range"] { width: 100%; accent-color: #6c9; }
  .field select, .field input[type="number"] {
    width: 100%;
    padding: 4px 6px;
    background: #222;
    color: #ddd;
    border: 1px solid #333;
    border-radius: 4px;
    font-size: 13px;
    font-family: inherit;
  }
  .range-row { display: flex; align-items: center; gap: 8px; }
  .range-row input[type="range"] { flex: 1; }
  .range-row .val { font-size: 12px; color: #999; min-width: 50px; text-align: right; font-variant-numeric: tabular-nums; }

  .config-panel {
    background: #1a1a1a;
    border: 1px solid #2a2a2a;
    border-radius: 8px;
    padding: 16px;
    display: flex;
    flex-direction: column;
  }
  .config-panel h3 {
    font-size: 13px;
    color: #888;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .config-panel pre {
    flex: 1;
    background: #111;
    border: 1px solid #222;
    border-radius: 4px;
    padding: 12px;
    font-size: 12px;
    color: #b0d0b0;
    overflow: auto;
    white-space: pre-wrap;
    word-break: break-all;
    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
  }
  .btn-sm {
    padding: 3px 10px;
    background: #222;
    color: #aaa;
    border: 1px solid #333;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    font-family: inherit;
  }
  .btn-sm:hover { background: #2a2a2a; border-color: #555; }
  .actions { display: flex; gap: 8px; margin-bottom: 16px; }
  .actions button {
    padding: 8px 16px;
    background: #1a2a1a;
    color: #6c9;
    border: 1px solid #3a5a3a;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    font-family: inherit;
  }
  .actions button:hover { background: #2a3a2a; }
  .copied {
    color: #6c9;
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .copied.show { opacity: 1; }
</style>
</head>
<body>

<h1>chirp playground</h1>
<p class="subtitle">click a preset to load it, tweak parameters, hit play</p>

<h2>presets</h2>
<div class="presets" id="presets"></div>

<div class="actions">
  <button onclick="playCurrentConfig()">&#9654; play</button>
  <button onclick="addLayer()">+ add layer</button>
</div>

<div class="editor">
  <div class="layers" id="layers"></div>
  <div class="config-panel">
    <h3>
      config
      <span>
        <button class="btn-sm" onclick="copyConfig()">copy</button>
        <span class="copied" id="copied">copied!</span>
      </span>
    </h3>
    <pre id="config-output"></pre>
  </div>
</div>

<script>
// ============ INLINED ENGINE ============

let audioCtx = null
function getCtx() {
  if (!audioCtx) audioCtx = new AudioContext()
  if (audioCtx.state === 'suspended') audioCtx.resume()
  return audioCtx
}

function createNoiseBuffer(ctx, duration) {
  const sr = ctx.sampleRate
  const len = Math.max(1, Math.floor(sr * duration))
  const buf = ctx.createBuffer(1, len, sr)
  const d = buf.getChannelData(0)
  for (let i = 0; i < len; i++) d[i] = Math.random() * 2 - 1
  return buf
}

function playSound(config) {
  const ctx = getCtx()
  for (const layer of config.layers) playLayer(ctx, layer)
}

function playLayer(ctx, layer) {
  const start = ctx.currentTime + (layer.delay || 0)
  const curve = layer.envelope.curve || 'exponential'
  let src
  if (layer.source.type === 'oscillator') {
    src = ctx.createOscillator()
    src.type = layer.source.waveform
    src.frequency.setValueAtTime(layer.source.frequency, start)
    if (layer.source.frequencyEnd != null) {
      const end = start + layer.envelope.attack + layer.envelope.decay
      if (curve === 'exponential') {
        src.frequency.exponentialRampToValueAtTime(Math.max(layer.source.frequencyEnd, 0.001), end)
      } else {
        src.frequency.linearRampToValueAtTime(layer.source.frequencyEnd, end)
      }
    }
  } else {
    const dur = layer.envelope.attack + layer.envelope.decay
    const buf = createNoiseBuffer(ctx, dur + 0.1)
    src = ctx.createBufferSource()
    src.buffer = buf
  }

  let filter = null
  if (layer.filter) {
    filter = ctx.createBiquadFilter()
    filter.type = layer.filter.type
    filter.frequency.setValueAtTime(layer.filter.frequency, start)
    if (layer.filter.Q != null) filter.Q.setValueAtTime(layer.filter.Q, start)
  }

  const gain = ctx.createGain()
  const peak = layer.gain
  const decayEnd = start + layer.envelope.attack + layer.envelope.decay
  gain.gain.setValueAtTime(0.001, start)
  if (curve === 'exponential') {
    gain.gain.exponentialRampToValueAtTime(Math.max(peak, 0.001), start + layer.envelope.attack)
    gain.gain.exponentialRampToValueAtTime(0.001, decayEnd)
  } else {
    gain.gain.linearRampToValueAtTime(peak, start + layer.envelope.attack)
    gain.gain.linearRampToValueAtTime(0, decayEnd)
  }

  let node = src
  if (filter) { node.connect(filter); node = filter }
  node.connect(gain)
  gain.connect(ctx.destination)
  src.start(start)
  src.stop(decayEnd + 0.05)
}

// ============ PRESETS ============

const PRESETS = {
  click: {
    layers: [{
      source: { type: 'noise' },
      filter: { type: 'bandpass', frequency: 2000, Q: 1.5 },
      envelope: { attack: 0.001, decay: 0.05 },
      gain: 0.3,
    }],
  },
  pop: {
    layers: [{
      source: { type: 'oscillator', waveform: 'sine', frequency: 520, frequencyEnd: 340 },
      envelope: { attack: 0.001, decay: 0.08 },
      gain: 0.35,
    }],
  },
  toggle: {
    layers: [
      { source: { type: 'oscillator', waveform: 'sine', frequency: 440 }, envelope: { attack: 0.001, decay: 0.06 }, gain: 0.25 },
      { source: { type: 'oscillator', waveform: 'sine', frequency: 580 }, envelope: { attack: 0.001, decay: 0.06 }, gain: 0.25, delay: 0.06 },
    ],
  },
  tick: {
    layers: [{
      source: { type: 'noise' },
      filter: { type: 'highpass', frequency: 4000, Q: 0.5 },
      envelope: { attack: 0.001, decay: 0.03 },
      gain: 0.15,
    }],
  },
  drop: {
    layers: [{
      source: { type: 'oscillator', waveform: 'sine', frequency: 600, frequencyEnd: 200 },
      envelope: { attack: 0.001, decay: 0.2 },
      gain: 0.3,
    }],
  },
  success: {
    layers: [
      { source: { type: 'oscillator', waveform: 'sine', frequency: 523 }, envelope: { attack: 0.001, decay: 0.25 }, gain: 0.2 },
      { source: { type: 'oscillator', waveform: 'sine', frequency: 659 }, envelope: { attack: 0.001, decay: 0.25 }, gain: 0.2, delay: 0.05 },
      { source: { type: 'oscillator', waveform: 'sine', frequency: 784 }, envelope: { attack: 0.001, decay: 0.3 }, gain: 0.2, delay: 0.1 },
    ],
  },
  error: {
    layers: [
      { source: { type: 'oscillator', waveform: 'square', frequency: 180 }, envelope: { attack: 0.001, decay: 0.15 }, gain: 0.2 },
      { source: { type: 'oscillator', waveform: 'square', frequency: 196 }, envelope: { attack: 0.001, decay: 0.15 }, gain: 0.2 },
    ],
  },
  warning: {
    layers: [{
      source: { type: 'oscillator', waveform: 'triangle', frequency: 440 },
      envelope: { attack: 0.001, decay: 0.18 },
      gain: 0.3,
    }],
  },
}

// ============ STATE ============

let currentConfig = JSON.parse(JSON.stringify(PRESETS.click))
let activePreset = 'click'

// ============ UI ============

const WAVEFORMS = ['sine', 'triangle', 'square', 'sawtooth']
const FILTER_TYPES = ['lowpass', 'highpass', 'bandpass', 'notch', 'allpass', 'peaking', 'lowshelf', 'highshelf']
const SOURCE_TYPES = ['oscillator', 'noise']

function renderPresets() {
  const el = document.getElementById('presets')
  el.innerHTML = ''
  for (const name of Object.keys(PRESETS)) {
    const btn = document.createElement('button')
    btn.textContent = name
    if (name === activePreset) btn.classList.add('active')
    btn.onclick = () => {
      activePreset = name
      currentConfig = JSON.parse(JSON.stringify(PRESETS[name]))
      render()
      playSound(currentConfig)
    }
    el.appendChild(btn)
  }
}

function makeRangeField(label, value, min, max, step, onChange) {
  const div = document.createElement('div')
  div.className = 'field'
  const lbl = document.createElement('label')
  lbl.textContent = label
  div.appendChild(lbl)
  const row = document.createElement('div')
  row.className = 'range-row'
  const input = document.createElement('input')
  input.type = 'range'
  input.min = min
  input.max = max
  input.step = step
  input.value = value
  const val = document.createElement('span')
  val.className = 'val'
  val.textContent = Number(value).toFixed(step < 1 ? 3 : 0)
  input.oninput = () => {
    const v = parseFloat(input.value)
    val.textContent = v.toFixed(step < 1 ? 3 : 0)
    onChange(v)
    updateConfigOutput()
  }
  row.appendChild(input)
  row.appendChild(val)
  div.appendChild(row)
  return div
}

function makeSelectField(label, value, options, onChange) {
  const div = document.createElement('div')
  div.className = 'field'
  const lbl = document.createElement('label')
  lbl.textContent = label
  div.appendChild(lbl)
  const sel = document.createElement('select')
  for (const opt of options) {
    const o = document.createElement('option')
    o.value = opt
    o.textContent = opt
    if (opt === value) o.selected = true
    sel.appendChild(o)
  }
  sel.onchange = () => {
    onChange(sel.value)
    updateConfigOutput()
  }
  div.appendChild(sel)
  return div
}

function renderLayer(layer, index) {
  const card = document.createElement('div')
  card.className = 'layer-card'

  const h3 = document.createElement('h3')
  h3.innerHTML = `Layer ${index + 1} `
  const del = document.createElement('button')
  del.textContent = 'Ã—'
  del.onclick = () => {
    currentConfig.layers.splice(index, 1)
    render()
  }
  h3.appendChild(del)
  card.appendChild(h3)

  // source type
  card.appendChild(makeSelectField('source', layer.source.type, SOURCE_TYPES, v => {
    if (v === 'oscillator') {
      layer.source = { type: 'oscillator', waveform: 'sine', frequency: 440 }
    } else {
      layer.source = { type: 'noise' }
    }
    render()
  }))

  if (layer.source.type === 'oscillator') {
    card.appendChild(makeSelectField('waveform', layer.source.waveform, WAVEFORMS, v => { layer.source.waveform = v }))
    card.appendChild(makeRangeField('frequency', layer.source.frequency, 20, 8000, 1, v => { layer.source.frequency = v }))
    card.appendChild(makeRangeField('frequencyEnd', layer.source.frequencyEnd || 0, 0, 8000, 1, v => { layer.source.frequencyEnd = v || undefined }))
  }

  // filter toggle
  const hasFilter = !!layer.filter
  card.appendChild(makeSelectField('filter', hasFilter ? layer.filter.type : 'none', ['none', ...FILTER_TYPES], v => {
    if (v === 'none') {
      delete layer.filter
    } else {
      layer.filter = layer.filter || { type: v, frequency: 1000, Q: 1 }
      layer.filter.type = v
    }
    render()
  }))

  if (layer.filter) {
    card.appendChild(makeRangeField('filter freq', layer.filter.frequency, 20, 16000, 1, v => { layer.filter.frequency = v }))
    card.appendChild(makeRangeField('filter Q', layer.filter.Q ?? 1, 0.1, 20, 0.1, v => { layer.filter.Q = v }))
  }

  // envelope
  card.appendChild(makeRangeField('attack', layer.envelope.attack, 0.001, 0.5, 0.001, v => { layer.envelope.attack = v }))
  card.appendChild(makeRangeField('decay', layer.envelope.decay, 0.01, 2, 0.01, v => { layer.envelope.decay = v }))
  card.appendChild(makeRangeField('gain', layer.gain, 0, 1, 0.01, v => { layer.gain = v }))
  card.appendChild(makeRangeField('delay', layer.delay || 0, 0, 1, 0.01, v => { layer.delay = v || undefined }))

  return card
}

function renderLayers() {
  const el = document.getElementById('layers')
  el.innerHTML = ''
  currentConfig.layers.forEach((layer, i) => {
    el.appendChild(renderLayer(layer, i))
  })
}

function updateConfigOutput() {
  // strip undefined-ish values for clean output
  const clean = JSON.parse(JSON.stringify(currentConfig, (k, v) => {
    if (v === undefined || v === 0 && (k === 'frequencyEnd' || k === 'delay')) return undefined
    return v
  }))
  document.getElementById('config-output').textContent = JSON.stringify(clean, null, 2)
}

function render() {
  renderPresets()
  renderLayers()
  updateConfigOutput()
}

// ============ ACTIONS ============

function playCurrentConfig() {
  playSound(currentConfig)
}

function addLayer() {
  currentConfig.layers.push({
    source: { type: 'oscillator', waveform: 'sine', frequency: 440 },
    envelope: { attack: 0.001, decay: 0.1 },
    gain: 0.25,
  })
  render()
}

function copyConfig() {
  const clean = JSON.parse(JSON.stringify(currentConfig, (k, v) => {
    if (v === undefined || v === 0 && (k === 'frequencyEnd' || k === 'delay')) return undefined
    return v
  }))
  const text = `const config: SoundConfig = ${JSON.stringify(clean, null, 2)}`
  navigator.clipboard.writeText(text).then(() => {
    const el = document.getElementById('copied')
    el.classList.add('show')
    setTimeout(() => el.classList.remove('show'), 1500)
  })
}

// boot
render()
</script>
</body>
</html>
